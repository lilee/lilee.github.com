<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="李锂" />
    <title>CEscapeString | 李锂</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/feed/" rel="alternate" title="李锂" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/style.css">
    <link rel="stylesheet" href="/media/css/highlight.css">
    <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <h1>CEscapeString</h1>
        </header>
        <nav>
        <span><a title="home page" class="" href="/">home</a></span>
        <span><a title="about" class="" href="/about/">about</a></span>
        <span><a title="categories" class="" href="/categories/">categories</a></span>
        <span><a title="tags" class="" href="/tags/">tags</a></span>
        <span><a title="links" class="" href="/links/">links</a></span>
        <span><a title="subscribe by RSS" class="" href="/feed/">subscribe</a></span>
        </nav>
        <article class="content">
        <section class="post">
<p>最近在项目中使用LOG打印调试信息日志时，有些需要打印的数据中含有不可显示的字符，在终端上就显示成了问号或者是乱码。这样非常不利于判断打印的调试信息中的数据是否正常。</p>

<p>但笔者最近在使用protobuf时，发现使用它的Message::DebugString的接口可以把不可显示的字符进行转义输出。protobuf中将这个转义函数叫做CEscapeString，意思是:</p>

<blockquote>
<p>escaping dangerous characters using C-style escape sequences (将危险的字符进行C风格的转义)</p>
</blockquote>

<p>首先看看CEscapeString的签名</p>
<div class='highlight'><pre><code class='cpp'><span class='c1'>// CEscapeString()</span>
<span class='c1'>//    Copies &#39;src&#39; to &#39;dest&#39;, escaping dangerous characters using</span>
<span class='c1'>//    C-style escape sequences. This is very useful for preparing query</span>
<span class='c1'>//    flags. &#39;src&#39; and &#39;dest&#39; should not overlap.</span>
<span class='c1'>//    Returns the number of bytes written to &#39;dest&#39; (not including the \0)</span>
<span class='c1'>//    or -1 if there was insufficient space.</span>
<span class='c1'>//</span>
<span class='c1'>//    Currently only \n, \r, \t, &quot;, &#39;, \ and !isprint() chars are escaped.</span>
<span class='kt'>int</span> <span class='n'>CEscapeString</span><span class='p'>(</span><span class='k'>const</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>src</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>src_len</span><span class='p'>,</span>
                  <span class='kt'>char</span><span class='o'>*</span> <span class='n'>dest</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>dest_len</span><span class='p'>);</span>
</code></pre>
</div>
<p>google代码中的注释非常详细，值得学习。注释中还解释说CEscapeString在preparing query flags时非常有用。也就是说，你通过gflags或者其他方式向命令行传递一些不可显示字符时就需要使用到这种方式。目前仅只对\n,\r,\t, &#8220;, &#8216;, \ 和不可显示字符做转义</p>

<p>概念了解了，实现很简单，所有码农都会写。这里还是贴出google的官方版本实现。可以窥探出CEscapeString实现的更多细节，这里不做过多解释</p>
<div class='highlight'><pre><code class='cpp'><span class='kt'>int</span> <span class='n'>CEscapeInternal</span><span class='p'>(</span><span class='k'>const</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>src</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>src_len</span><span class='p'>,</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>dest</span><span class='p'>,</span>
                    <span class='kt'>int</span> <span class='n'>dest_len</span><span class='p'>,</span> <span class='kt'>bool</span> <span class='n'>use_hex</span><span class='p'>,</span> <span class='kt'>bool</span> <span class='n'>utf8_safe</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>const</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>src_end</span> <span class='o'>=</span> <span class='n'>src</span> <span class='o'>+</span> <span class='n'>src_len</span><span class='p'>;</span>
  <span class='kt'>int</span> <span class='n'>used</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
  <span class='kt'>bool</span> <span class='n'>last_hex_escape</span> <span class='o'>=</span> <span class='kc'>false</span><span class='p'>;</span> <span class='c1'>// true if last output char was \xNN</span>

  <span class='k'>for</span> <span class='p'>(;</span> <span class='n'>src</span> <span class='o'>&lt;</span> <span class='n'>src_end</span><span class='p'>;</span> <span class='n'>src</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='n'>dest_len</span> <span class='o'>-</span> <span class='n'>used</span> <span class='o'>&lt;</span> <span class='mi'>2</span><span class='p'>)</span>   <span class='c1'>// Need space for two letter escape</span>
      <span class='k'>return</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>

    <span class='kt'>bool</span> <span class='n'>is_hex_escape</span> <span class='o'>=</span> <span class='kc'>false</span><span class='p'>;</span>
    <span class='k'>switch</span> <span class='p'>(</span><span class='o'>*</span><span class='n'>src</span><span class='p'>)</span> <span class='p'>{</span>
      <span class='k'>case</span> <span class='sc'>&#39;\n&#39;</span><span class='o'>:</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\\&#39;</span><span class='p'>;</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;n&#39;</span><span class='p'>;</span>  <span class='k'>break</span><span class='p'>;</span>
      <span class='k'>case</span> <span class='sc'>&#39;\r&#39;</span><span class='o'>:</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\\&#39;</span><span class='p'>;</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;r&#39;</span><span class='p'>;</span>  <span class='k'>break</span><span class='p'>;</span>
      <span class='k'>case</span> <span class='sc'>&#39;\t&#39;</span><span class='o'>:</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\\&#39;</span><span class='p'>;</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;t&#39;</span><span class='p'>;</span>  <span class='k'>break</span><span class='p'>;</span>
      <span class='k'>case</span> <span class='sc'>&#39;\&quot;&#39;</span><span class='o'>:</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\\&#39;</span><span class='p'>;</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\&quot;&#39;</span><span class='p'>;</span> <span class='k'>break</span><span class='p'>;</span>
      <span class='k'>case</span> <span class='sc'>&#39;\&#39;&#39;</span><span class='o'>:</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\\&#39;</span><span class='p'>;</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\&#39;&#39;</span><span class='p'>;</span> <span class='k'>break</span><span class='p'>;</span>
      <span class='k'>case</span> <span class='sc'>&#39;\\&#39;</span><span class='o'>:</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\\&#39;</span><span class='p'>;</span> <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\\&#39;</span><span class='p'>;</span> <span class='k'>break</span><span class='p'>;</span>
      <span class='k'>default</span><span class='o'>:</span>
        <span class='c1'>// Note that if we emit \xNN and the src character after that is a hex</span>
        <span class='c1'>// digit then that digit must be escaped too to prevent it being</span>
        <span class='c1'>// interpreted as part of the character code by C.</span>
        <span class='k'>if</span> <span class='p'>((</span><span class='o'>!</span><span class='n'>utf8_safe</span> <span class='o'>||</span> <span class='k'>static_cast</span><span class='o'>&lt;</span><span class='n'>uint8</span><span class='o'>&gt;</span><span class='p'>(</span><span class='o'>*</span><span class='n'>src</span><span class='p'>)</span> <span class='o'>&lt;</span> <span class='mh'>0x80</span><span class='p'>)</span> <span class='o'>&amp;&amp;</span>
            <span class='p'>(</span><span class='o'>!</span><span class='n'>isprint</span><span class='p'>(</span><span class='o'>*</span><span class='n'>src</span><span class='p'>)</span> <span class='o'>||</span>
             <span class='p'>(</span><span class='n'>last_hex_escape</span> <span class='o'>&amp;&amp;</span> <span class='n'>isxdigit</span><span class='p'>(</span><span class='o'>*</span><span class='n'>src</span><span class='p'>))))</span> <span class='p'>{</span>
          <span class='k'>if</span> <span class='p'>(</span><span class='n'>dest_len</span> <span class='o'>-</span> <span class='n'>used</span> <span class='o'>&lt;</span> <span class='mi'>4</span><span class='p'>)</span> <span class='c1'>// need space for 4 letter escape</span>
            <span class='k'>return</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
          <span class='n'>sprintf</span><span class='p'>(</span><span class='n'>dest</span> <span class='o'>+</span> <span class='n'>used</span><span class='p'>,</span> <span class='p'>(</span><span class='n'>use_hex</span> <span class='o'>?</span> <span class='s'>&quot;</span><span class='se'>\\</span><span class='s'>x%02x&quot;</span> <span class='o'>:</span> <span class='s'>&quot;</span><span class='se'>\\</span><span class='s'>%03o&quot;</span><span class='p'>),</span>
                  <span class='k'>static_cast</span><span class='o'>&lt;</span><span class='n'>uint8</span><span class='o'>&gt;</span><span class='p'>(</span><span class='o'>*</span><span class='n'>src</span><span class='p'>));</span>
          <span class='n'>is_hex_escape</span> <span class='o'>=</span> <span class='n'>use_hex</span><span class='p'>;</span>
          <span class='n'>used</span> <span class='o'>+=</span> <span class='mi'>4</span><span class='p'>;</span>
        <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
          <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='o'>++</span><span class='p'>]</span> <span class='o'>=</span> <span class='o'>*</span><span class='n'>src</span><span class='p'>;</span> <span class='k'>break</span><span class='p'>;</span>
        <span class='p'>}</span>
    <span class='p'>}</span>
    <span class='n'>last_hex_escape</span> <span class='o'>=</span> <span class='n'>is_hex_escape</span><span class='p'>;</span>
  <span class='p'>}</span>

  <span class='k'>if</span> <span class='p'>(</span><span class='n'>dest_len</span> <span class='o'>-</span> <span class='n'>used</span> <span class='o'>&lt;</span> <span class='mi'>1</span><span class='p'>)</span>   <span class='c1'>// make sure that there is room for \0</span>
    <span class='k'>return</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>

  <span class='n'>dest</span><span class='p'>[</span><span class='n'>used</span><span class='p'>]</span> <span class='o'>=</span> <span class='sc'>&#39;\0&#39;</span><span class='p'>;</span>   <span class='c1'>// doesn&#39;t count towards return value though</span>
  <span class='k'>return</span> <span class='n'>used</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>CEscapeString</span><span class='p'>(</span><span class='k'>const</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>src</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>src_len</span><span class='p'>,</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>dest</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>dest_len</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>return</span> <span class='n'>CEscapeInternal</span><span class='p'>(</span><span class='n'>src</span><span class='p'>,</span> <span class='n'>src_len</span><span class='p'>,</span> <span class='n'>dest</span><span class='p'>,</span> <span class='n'>dest_len</span><span class='p'>,</span> <span class='kc'>false</span><span class='p'>,</span> <span class='kc'>false</span><span class='p'>);</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>这段代码是从protobuf目录中的src/google/protobuf/stubs/strutil.cc中抠取出来的。strutil.cc中还包含很多字符串相关操作，而且都有非常优秀的实现。可将其抽取出来丰富你的CPP公共库</p>
</section>
<section class="meta">
<span class="author">
    <a href="">李锂</a>
</span>
<span class="time">
  /
  <time datetime="2012-08-27">2012-08-27</time>
</span>
<br />

<span class="categories">
  in categories
  
  <a href="/categories/#代码片段" title="代码片段">代码片段</a>&nbsp;
  
</span>


<span class="tags">
  tagged with
  
  <a href="/tags/#cpp" title="cpp">cpp</a>&nbsp;
  
  <a href="/tags/#string" title="string">string</a>&nbsp;
  
</span>

</section>
<section class="comment">
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'lilee-blog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = '/2012/08/hello-jekyll-world/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>


        </article>
      </div>
    </div>
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=14924238" charset="UTF-8"></script>
  </body>
</html>
